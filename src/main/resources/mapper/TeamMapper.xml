<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kcc.pms.domain.team.mapper.TeamMapper">
    <cache />

    <select id="getTeamList" resultType="com.kcc.pms.domain.team.model.dto.TeamResponseDto">
        SELECT t.tm_no as key,
               t.tm_nm as title,
               t.tm_cont as teamDescription,
               pt.tm_nm as parentTeamName,
               NVL(
                       CASE
                           WHEN t.par_tm_no IS NULL THEN
                               (SELECT SUM(cnt)
                                FROM (SELECT tm_no, COUNT(*) as cnt
                                      FROM projectmember
                                      GROUP BY tm_no
                                     ) pm
                                WHERE pm.tm_no IN (
                                    SELECT t2.tm_no
                                    FROM team t2
                                    WHERE t2.prj_no = t.prj_no
                                    START WITH t2.tm_no = t.tm_no
                                    CONNECT BY PRIOR t2.tm_no = t2.par_tm_no
                                )
                               )
                           ELSE
                               (SELECT COUNT(*)
                                FROM projectmember pm2
                                WHERE pm2.tm_no = t.tm_no
                               )
                           END, 0) as totalCount,
               s.sys_ttl as systemName,
               t.par_tm_no as parentId,
               t.order_no as orderNo
        FROM team t,
             system s,
             team pt
        WHERE t.sys_no = s.sys_no(+)
          AND t.par_tm_no = pt.tm_no(+)
          AND t.prj_no = #{projectNo}
        ORDER BY NVL(t.par_tm_no, t.tm_no), t.order_no
    </select>

</mapper>