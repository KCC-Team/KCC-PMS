<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kcc.pms.domain.test.mapper.TestMapper">
    <resultMap id="testVO" type="TestVO">
        <result property="testType" column="test_type" />
        <result property="testTitle" column="test_title" />
        <result property="workTitle" column="work_title" />
        <result property="testPeriod" column="test_period" />
        <result property="testCaseCount" column="detail_count" />
        <result property="defectCount" column="defect_count" />
        <result property="testStatus" column="test_status" />
        <association property="testItem" column="test_item">
            <id property="test_no" column="test_no" />
            <result property="test_id" column="test_id" />
        </association>
    </resultMap>

    <resultMap id="TestDetailResultMap" type="TestDetailRequestDto">
        <id property="testDtlId" column="testDtlId"/>
        <result property="preCondition" column="preCondition"/>
        <result property="testCaseCont" column="testCaseCont"/>
        <result property="preoceedCont" column="preoceedCont"/>
        <result property="testData" column="testData"/>
        <result property="estimatedResult" column="estimatedRlt"/>
        <result property="note" column="note"/>
    </resultMap>

    <resultMap id="TestRequestResultMap" type="TestRequestDto">
        <id property="testNo" column="testNo"/>
        <result property="testTitle" column="testTitle"/>
        <result property="testId" column="testId"/>
        <result property="testStartDate" column="testStartDate"/>
        <result property="testEndDate" column="testEndDate"/>
        <result property="testType" column="testType"/>
        <result property="testStatus" column="testStatus"/>
        <result property="workType" column="workType"/>
        <result property="testCont" column="testCont"/>
        <result property="memberName" column="memberName"/>
        <collection property="testCaseList" resultMap="TestDetailResultMap"/>
    </resultMap>

    <select id="findAllByOptions" parameterType="map" resultMap="testVO">
        SELECT *
        FROM (
        SELECT sub.*, ROWNUM rn
        FROM (
        SELECT
        t.test_no AS test_no,
        t.test_id AS test_id,
        TRIM(cd_type.cd_dtl_nm) AS test_type,
        t.test_title,
        sys_work.sys_ttl AS work_title,
        TO_CHAR(t.test_st_dt, 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(t.test_end_dt, 'YYYY-MM-DD') AS test_period,
        COUNT(DISTINCT td.test_dtl_no) AS detail_count,
        COUNT(d.df_no) AS defect_count,
        TRIM(cd_stat.cd_dtl_nm) AS test_status
        FROM testmaster t
        LEFT JOIN testdetail td ON t.test_no = td.test_no
        LEFT JOIN codedetail cd_type ON t.type_cd = cd_type.cd_dtl_no
        LEFT JOIN codedetail cd_stat ON t.stat_cd = cd_stat.cd_dtl_no
        LEFT JOIN defect d ON td.test_dtl_no = d.test_dtl_no
        LEFT JOIN system sys_work ON sys_work.sys_no = t.sys_work_no
        WHERE t.prj_no = 1
        AND t.use_yn = 'Y'
        <if test="work_no != 0">
            AND t.sys_work_no = #{work_no, jdbcType=INTEGER}
        </if>
        <if test="test_type != 'all'">
            AND t.type_cd = #{test_type, jdbcType=CHAR}
        </if>
        <if test="status != 'all'">
            AND t.stat_cd = #{status, jdbcType=CHAR}
        </if>
        GROUP BY
        t.test_no, t.test_id, cd_type.cd_dtl_nm, t.test_title, sys_work.sys_ttl, t.test_st_dt, t.test_end_dt, cd_stat.cd_dtl_nm
        ORDER BY t.test_no
        ) sub
        <![CDATA[
            WHERE ROWNUM <= #{page} * #{limit}
        ]]>
        )
        WHERE rn > (#{page} - 1) * #{limit}
        ORDER BY test_no
    </select>

    <insert id="saveTest" parameterType="map">
        <selectKey keyProperty="testNo" resultType="int" order="BEFORE">
            SELECT SEQ_TESTMASTER.nextval FROM DUAL
        </selectKey>

        INSERT INTO testmaster
        (test_no, test_id, test_title, test_cont, stat_cd, type_cd,
        test_st_dt, test_end_dt, prj_no, sys_work_no, reg_id, reg_dt, use_yn)
        VALUES
        (#{testNo, jdbcType=INTEGER}, #{testId, jdbcType=VARCHAR}, #{testTitle, jdbcType=VARCHAR},
        #{testCont, jdbcType=VARCHAR}, #{testStatus, jdbcType=CHAR},
        #{testType, jdbcType=CHAR}, #{testStartDate, jdbcType=DATE}, #{testEndDate, jdbcType=DATE},
        #{prj_no, jdbcType=INTEGER}, #{workType, jdbcType=INTEGER},
        'admin',
        sysdate, 'Y')
    </insert>

    <insert id="saveUnitTestDetails" parameterType="map">
        INSERT INTO testdetail
        (
            test_dtl_no,
            test_dtl_id,
            wrk_proc_cont,
            test_data,
            estimated_rlt,
            test_detail_cont,
            proceed_cont,
            pre_cond,
            note,
            test_no
        )
        VALUES
            (
                SEQ_TESTDETAIL.nextval,
                #{testDtlId, jdbcType=VARCHAR},
                #{wrkProcCont, jdbcType=VARCHAR},
                #{testData, jdbcType=VARCHAR},
                #{estimatedResult, jdbcType=VARCHAR},
                #{testCaseCont, jdbcType=VARCHAR},
                #{preoceedCont, jdbcType=VARCHAR},
                #{preCondition, jdbcType=VARCHAR},
                #{note, jdbcType=VARCHAR},
                #{testNo, jdbcType=INTEGER}
            )
    </insert>

    <select id="getUnitTest" parameterType="long" resultMap="TestRequestResultMap">
        select
            t.test_no as testNo,
            t.test_title AS testTitle,
            t.test_id AS testId,
            t.test_st_dt AS testStartDate,
            t.test_end_dt AS testEndDate,
            TRIM(cd_type.cd_dtl_nm) AS testType,
            TRIM(cd_stat.cd_dtl_nm) AS testStatus,
            sys_work.sys_ttl AS workType,
            t.test_cont AS testCont,
--             m.mem_nm AS memberName,
            f.feat_title AS featureName,
            td.test_dtl_no AS testDtlId,
            td.pre_cond AS preCondition,
            td.test_detail_cont AS testCaseCont,
            td.proceed_cont AS preoceedCont,
            td.test_data AS testData,
            td.estimated_rlt AS estimatedResult,
            td.note AS note
        from testmaster t
                 left join TESTDETAIL td on t.test_no = td.test_no
                 left join codedetail cd_type on t.type_cd = cd_type.cd_dtl_no
                 left join codedetail cd_stat on t.stat_cd = cd_stat.cd_dtl_no
                 left join defect d on td.test_dtl_no = d.test_dtl_no
                 left join system sys_work ON sys_work.sys_no = t.sys_work_no
                 left join member m ON m.mem_no = td.mem_no
                 left join featureTest ft ON ft.test_dtl_no = td.test_dtl_no
                 left join feature f ON f.feat_no = ft.feat_no
        where t.test_no = #{testNo, jdbcType=INTEGER}
        order by td.test_dtl_no
    </select>

    <update id="deleteTest" parameterType="long">
        update testmaster t set t.use_yn = 'N' where test_no = #{testNo, jdbcType=INTEGER}
    </update>
</mapper>