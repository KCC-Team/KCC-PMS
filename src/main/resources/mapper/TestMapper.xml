<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kcc.pms.domain.test.mapper.TestMapper">
    <cache />

    <resultMap id="testVO" type="TestVO">
        <result property="testType" column="test_type" />
        <result property="testTitle" column="test_title" />
        <result property="workTitle" column="work_title" />
        <result property="testPeriod" column="test_period" />
        <result property="testCaseCount" column="detail_count" />
        <result property="defectCount" column="defect_count" />
        <result property="testStatus" column="test_status" />
        <association property="testItem" column="test_item">
            <id property="test_no" column="test_no" />
            <result property="test_id" column="test_id" />
        </association>
    </resultMap>
    
    <select id="findAllByOptions" parameterType="map" resultMap="testVO">
        select
            t.test_no AS test_no,
            t.test_id AS test_id,
            TRIM(cd_type.cd_dtl_nm) AS test_type,
            t.test_title, sys_work.sys_ttl AS work_title,
            TO_CHAR(t.test_st_dt, 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(t.test_end_dt, 'YYYY-MM-DD') AS test_period,
            count(distinct td.test_dtl_no) as detail_count, -- 결함 수에 따라 중복되는 테스트 케이스가 있을 수 있으므로 중복 제거
            count(d.df_no) AS defect_count,
            TRIM(cd_stat.cd_dtl_nm) AS test_status
        from testmaster t
        left join TESTDETAIL td on t.test_no = td.test_no
        left join codedetail cd_type on t.type_cd = cd_type.cd_dtl_no
        left join codedetail cd_stat on t.stat_cd = cd_stat.cd_dtl_no
        left join defect d on td.test_dtl_no = d.test_dtl_no
        left join system sys ON sys.sys_no = t.sys_no
        left join system sys_work ON sys_work.sys_no = t.sys_work_no
        and t.prj_no = 1
        <if test="sys_no != 0">
            and t.sys_no = #{sys_no, jdbcType=INTEGER}
        </if>
        <if test="work_no != 0">
            and t.sys_work_no = #{work_no, jdbcType=INTEGER}
        </if>
        <if test="test_type != 'all'">
            and t.type_cd = #{test_type, jdbcType=CHAR}
        </if>
        <if test="status != 'all'">
            and t.stat_cd = #{status, jdbcType=CHAR}
        </if>
        group by
            t.test_no, t.test_id, cd_type.cd_dtl_nm, t.test_title, sys_work.sys_ttl, t.test_st_dt, t.test_end_dt, cd_stat.cd_dtl_nm
        ORDER BY t.test_no
    </select>

    <insert id="saveTest" parameterType="map">
        insert into testmaster
        (test_no, test_id, test_title, test_cont, stat_cd, type_cd, test_st_dt, test_end_dt, created_dt, prj_no, sys_no, sys_work_no)
        values
        (#{test_no, jdbcType=INTEGER}, #{test_id, jdbcType=VARCHAR}, #{test_title, jdbcType=VARCHAR}, #{test_cont, jdbcTypeVARCHAR}, #{test_status, jdbcType=CHAR},
        #{test_type, jdbcType=CHAR}, #{test_st_dt, jdbcType=DATE}, #{test_end_dt, jdbcType=DATE}, sysdate,
        #{prj_no, jdbcType=INTEGER}, #{sys_no, jdbcType=INTEGER}, #{work_no, jdbcType=INTEGER})
    </insert>

    <insert id="saveUnitTestDetails" parameterType="map">
        insert into testdetail
        (test_dtl_no, test_no, test_dtl_id, test_no, test_dtl_title, test_dtl_cont, test_dtl_st_dt, test_dtl_end_dt, created_dt, prj_no, sys_no, sys_work_no)
        values
        (#{test_dtl_no, jdbcType=INTEGER}, #{test_no, jdbcType=INTEGER}, #{test_no, jdbcType=VARCHAR}, #{test_dtl_id, jdbcType=VARCHAR}, #{test_dtl_title, jdbcType=VARCHAR},
        #{test_dtl_cont, jdbcType=VARCHAR}, #{test_dtl_st_dt, jdbcType=DATE}, #{test_dtl_end_dt, jdbcType=DATE}, sysdate,
        #{prj_no, jdbcType=INTEGER}, #{sys_no, jdbcType=INTEGER}, #{work_no, jdbcType=INTEGER})
    </insert>
</mapper>