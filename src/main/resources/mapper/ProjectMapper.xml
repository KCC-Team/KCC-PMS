<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kcc.pms.domain.project.mapper.ProjectMapper">

    <insert id="saveProject" parameterType="com.kcc.pms.domain.project.model.dto.ProjectRequestDto">
        <selectKey keyProperty="prj_no" resultType="long" order="BEFORE">
            SELECT seq_project.nextval FROM dual
        </selectKey>
        insert into project
        (prj_no, prj_title, prj_cont, stat_cd, prg, org, pre_st_dt, pre_end_dt, use_yn,
        <if test="st_dt != null">st_dt,</if>
        <if test="end_dt != null">end_dt,</if>
        reg_id, reg_dt)
        values (#{prj_no}, #{prj_title}, #{prj_cont}, #{stat_cd}, #{prg}, #{org}, #{pre_st_dt}, #{pre_end_dt}, 'Y',
        <if test="st_dt != null">#{st_dt},</if>
        <if test="end_dt != null">#{end_dt},</if>
        #{reg_id}, SYSDATE)
    </insert>

    <insert id="saveTeam" parameterType="com.kcc.pms.domain.project.model.dto.ProjectRequestDto">
        <selectKey keyProperty="tm_no" resultType="long" order="BEFORE">
            SELECT seq_team.nextval FROM dual
        </selectKey>
        insert into team
        (tm_no, tm_nm, prj_no, use_yn,
        <if test="tm_cont != null">tm_cont,</if>
        <if test="par_tm_no != null">par_tm_no,</if>
        <if test="sys_no != null">sys_no,</if>
        reg_id, reg_dt)
        values (#{tm_no}, #{prj_title}, #{prj_no}, 'Y',
        <if test="tm_cont != null">#{tm_cont},</if>
        <if test="par_tm_no != null">#{par_tm_no},</if>
        <if test="sys_no != null">#{sys_no},</if>
        #{reg_id}, SYSDATE)
    </insert>

    <insert id="saveProjectMember" parameterType="com.kcc.pms.domain.project.model.dto.ProjectRequestDto">
        insert into projectmember
        (mem_no, tm_no, prj_no, prj_auth_cd, use_yn,
        <if test="pm_pre_start_dt != null">pre_start_dt,</if>
        <if test="pm_pre_end_dt != null">pre_end_dt,</if>
        <if test="pm_start_dt != null">start_dt,</if>
        <if test="pm_end_dt != null">end_dt,</if>
        reg_id, reg_dt)
        values (#{mem_no}, #{tm_no}, #{prj_no}, #{prj_auth_cd}, 'Y',
        <if test="pm_pre_start_dt != null">#{pm_pre_start_dt},</if>
        <if test="pm_pre_end_dt != null">#{pm_pre_end_dt},</if>
        <if test="pm_start_dt != null">#{pm_start_dt},</if>
        <if test="pm_end_dt != null">#{pm_end_dt},</if>
        #{reg_id}, SYSDATE)
    </insert>


    <resultMap id="projectResultMap" type="com.kcc.pms.domain.project.model.dto.ProjectResponseDto">
        <result property="prj_no" column="prj_no"/>
        <result property="project_status" column="project_status"/>
        <collection property="projectManager" ofType="com.kcc.pms.domain.project.model.dto.ProjectManagerResponseDto"
                    column="prj_no" javaType="list" select="getProjectManager">
            <result property="memNo" column="mem_no"/>
            <result property="memNm" column="mem_nm"/>
        </collection>
    </resultMap>


    <select id="getProjects" resultMap="projectResultMap">
        SELECT
            inline_query.*,
            CASE
                WHEN inline_query.stat_cd = 'PMS00101' THEN '대기'
                WHEN inline_query.stat_cd = 'PMS00102' THEN '진행중'
                ELSE '완료'
            END AS project_status
        FROM
        (
            SELECT
                rownum rn,
                P.*,
                CASE
                    WHEN P.stat_cd = 'PMS00101' THEN '대기'
                    WHEN P.stat_cd = 'PMS00102' THEN '진행중'
                    ELSE '완료'
                END AS project_status
            FROM
                project P
            JOIN
                team T ON P.prj_no = T.prj_no
            JOIN
                projectmember PM ON P.prj_no = PM.prj_no
            JOIN
                member M ON PM.mem_no = M.mem_no
            WHERE
                <![CDATA[
                    rownum <= #{cri.pageNum} * #{cri.amount}
                ]]>
                    AND M.login_id = #{prjReqDto.login_id}
                <if test="prjReqDto.prj_title != null and prjReqDto.prj_title != ''">
                    AND REPLACE(prj_title, ' ', '') like '%' || REPLACE(#{prjReqDto.prj_title}, ' ', '') || '%'
                </if>
                <if test="prjReqDto.stat_cd != null and prjReqDto.stat_cd != 'all'">
                    AND stat_cd = #{prjReqDto.stat_cd}
                </if>
        ) inline_query
        WHERE
        <![CDATA[
            inline_query.rn > (#{cri.pageNum} -1) * #{cri.amount}
        ]]>
        ORDER BY
            CASE
                WHEN stat_cd = 'PMS00102' THEN 1
                WHEN stat_cd = 'PMS00101' THEN 2
                ELSE 3
            END,
        st_dt DESC NULLS LAST,
        prj_no DESC
    </select>


    <select id="getProjectManager" resultType="com.kcc.pms.domain.project.model.dto.ProjectManagerResponseDto">
        SELECT M.mem_no as memNo , M.mem_nm as memNm
        FROM
            projectmember PM
        JOIN
            member M ON PM.mem_no = M.mem_no
        WHERE
            PM.prj_no = #{prj_no}
        AND
            PM.prj_auth_cd = 'PMS00201'
    </select>


    <select id="getProjectCount" resultType="int">
        SELECT
            COUNT(prj_no)
        FROM
            project P
        JOIN
            team T ON P.prj_no = T.prj_no
        JOIN
            projectmember PM ON P.prj_no = PM.prj_no
        JOIN
            member M ON PM.mem_no = M.mem_no
        WHERE
            M.login_id = #{prjReqDto.login_id}
            <if test="prjReqDto.prj_title != null and prjReqDto.prj_title != ''">
                AND REPLACE(prj_title, ' ', '') like '%' || REPLACE(#{prjReqDto.prj_title}, ' ', '') || '%'
            </if>
            <if test="prjReqDto.stat_cd != null and prjReqDto.stat_cd != 'all'">
                AND stat_cd = #{prjReqDto.stat_cd}
            </if>
    </select>



</mapper>